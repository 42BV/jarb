<?xml version="1.0" encoding="UTF-8"?>
<beans
		xmlns="http://www.springframework.org/schema/beans"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:constraints="http://www.jarbframework.org/schema/constraints"
        xmlns:migrations="http://www.jarbframework.org/schema/migrations"
        xmlns:populator="http://www.jarbframework.org/schema/populator"
        xmlns:context="http://www.springframework.org/schema/context"
        xmlns:tx="http://www.springframework.org/schema/tx"
        xmlns:jee="http://www.springframework.org/schema/jee"
        xmlns:jdbc="http://www.springframework.org/schema/jdbc"
        xmlns:jpa="http://www.springframework.org/schema/data/jpa"
        xsi:schemaLocation="
            http://www.jarbframework.org/schema/constraints http://www.jarbframework.org/schema/constraints/jarb-constraints.xsd
            http://www.jarbframework.org/schema/migrations http://www.jarbframework.org/schema/migrations/jarb-migrations.xsd
            http://www.jarbframework.org/schema/populator http://www.jarbframework.org/schema/populator/jarb-populator.xsd
	        http://www.springframework.org/schema/beans	http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
	        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd
	        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.2.xsd
            http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-3.2.xsd
            http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-3.2.xsd
	        http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd">

    <context:component-scan base-package="org.jarbframework.sample"/>

    <!-- Create in-memory database -->
    <jdbc:embedded-database id="dataSource" type="HSQL"/>

    <!-- Object relational mapping using Hibernate and Spring -->
    <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
        <property name="jpaPropertyMap">
            <map>
                <entry key="hibernate.ejb.naming_strategy" value="org.hibernate.cfg.ImprovedNamingStrategy"/>
                <entry key="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect"/>
                <entry key="hibernate.hbm2ddl.auto" value="validate"/>
                <!-- Ensure the spring aware validation factory is used -->
                <entry key="javax.persistence.validation.factory" value-ref="validator"/>
            </map>
        </property>
        <property name="dataSource" ref="dataSource"/>
    </bean>

	<!-- Transaction support -->
    <tx:annotation-driven transaction-manager="transactionManager"/>
    <bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
        <property name="entityManagerFactory" ref="entityManagerFactory"/>
    </bean>

    <!-- Internationalization (i18n) - Overwrites the default name of Spring. -->
    <bean id="messageSource" class="org.springframework.context.support.ResourceBundleMessageSource">
        <property name="basename" value="messages"/>
    </bean>

    <!-- Validations (also uses the messageSource defined above) -->
    <bean id="validator" class="org.springframework.validation.beanvalidation.LocalValidatorFactoryBean">
        <property name="validationMessageSource" ref="messageSource"/>
    </bean>

    <constraints:enable-metadata entity-manager-factory="entityManagerFactory"/>
    <constraints:translate-exceptions data-source="dataSource" base-package="org.jarbframework.sample"/>

    <jpa:repositories base-package="org.jarbframework.sample"/>
    
    <import resource="mvc-context.xml"/>

    <beans profile="test">
        <!-- Create the database schema using Liquibase -->
        <migrations:migrate data-source="dataSource" base="file:src/main/db" path="changelog.groovy"/>

		<!-- Populates the database with test data -->
        <populator:populate initializer="populator" destroyer="destroyer"/>

        <bean id="populator" class="org.jarbframework.populator.DatabasePopulatorChain">
           <constructor-arg>
                <list>
                    <bean class="org.jarbframework.populator.SqlResourceDatabasePopulator">
                        <constructor-arg ref="dataSource"/>
                        <constructor-arg value="classpath:import.sql"/>
                    </bean>
                    <bean class="org.jarbframework.populator.excel.ExcelDatabasePopulator">
                        <constructor-arg ref="entityManagerFactory"/>
                        <constructor-arg value="classpath:import.xls"/>
                    </bean>
                    <bean class="org.jarbframework.sample.PostPopulator"/>
                </list>
            </constructor-arg>
        </bean>
         
        <bean id="destroyer" class="org.jarbframework.populator.SqlResourceDatabasePopulator">
            <constructor-arg ref="dataSource"/>
            <constructor-arg value="classpath:clean.sql"/>
        </bean>
    </beans>

</beans>
